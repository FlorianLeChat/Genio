{% extends 'base.html.twig' %}
{% block content %}
    <h1>{{ personne.nom }} {{ personne.prenom }}</h1>

    <p>Date de naissance : {{ personne.dateNaissance|date('d/m/Y') }}</p>

    {% if personne.dateDeces is not null %}
        <p>Date de décès : {{ personne.dateDeces|date('d/m/Y') }}</p>
    {% endif %}

    <h2>Ancêtres</h2>

	<ul>
		{# Fonction pour afficher les parents d'une personne #}
		{% macro displayParents(ancestors, personId, originId) %}
			{% set person = ancestors|filter(v => v.id == personId)|first %}

			{# On vérifie que la personne existe bien #}
			{% if person is not null %}
				{# On affiche l'origine de l'arbre uniquement pour la personne recherchée #}
				{% if person.id == originId %}
					<li>
						{{ person.nom }} {{ person.prenom }} ({{ person.sexe }})

						<em>({{ person.date_naissance }})</em>
					</li>
				{% endif %}

				{# Récupération de l'identifiant unique du père et de ses informations (si disponible) #}
				{% set fatherId = ancestors|filter(v => v.personne2_id == person.id and v.relation_type_id == 1)|first %}
				{% set fatherData = null %}
				{% if fatherId is iterable %}
					{% set fatherData = ancestors|filter(v => v.id == fatherId.personne1_id)|first %}
				{% endif %}

				{# Récupération de l'identifiant unique de la mère et de ses informations (si disponible) #}
				{% set motherId = ancestors|filter(v => v.personne2_id == person.id and v.relation_type_id == 2)|first %}
				{% set motherData = null %}
				{% if motherId is iterable %}
					{% set motherData = ancestors|filter(v => v.id == motherId.personne1_id)|first %}
				{% endif %}

				<ul class="ancetors">
					{% if fatherData is not null %}
						{# Affichage des informations du père #}
						<li>
							<strong>Père</strong>

							{{ fatherData.nom }} {{ fatherData.prenom }} ({{ fatherData.sexe }})

							<em>({{ fatherData.date_naissance }})</em>
						</li>

						{# Appel récursif de la fonction pour afficher les parents du père #}
						{{ _self.displayParents(ancestors, fatherData.id, originId) }}
					{% endif %}

					{% if motherData is not null %}
						{# Affichage des informations de la mère #}
						<li>
							<strong>Mère</strong>

							{{ motherData.nom }} {{ motherData.prenom }} ({{ motherData.sexe }})

							<em>({{ motherData.date_naissance }})</em>
						</li>

						{# Appel récursif de la fonction pour afficher les parents de la mère #}
						{{ _self.displayParents(ancestors, motherData.id, originId) }}
					{% endif %}

					{% if fatherData is null and motherData is null %}
							<button id="addButton">Ajouter</button>
							<form class="addAncetors" data-id="{{ personId }}">
								<div>
									<h2>Père</h2>
									<label for="pere_nom">Nom:</label>
									<input type="text" id="pere_nom" name="pere_nom" required><br>

									<label for="pere_prenom">Prénom:</label>
									<input type="text" id="pere_prenom" name="pere_prenom" required><br>

									<label for="pere_date_naissance">Date de naissance:</label>
									<input type="date" id="pere_date_naissance" name="pere_date_naissance" required><br>

									<label for="pere_date_deces">Date de décès:</label>
									<input type="date" id="pere_date_deces" name="pere_date_deces" required><br>

									<label for="pere_lieu_naissance">Lieu de naissance:</label>
									<input type="text" id="pere_lieu_naissance" name="pere_lieu_naissance" required><br>
								</div>

								<div>
									<h2>Mère</h2>
									<label for="mere_nom">Nom:</label>
									<input type="text" id="mere_nom" name="mere_nom" required><br>

									<label for="mere_prenom">Prénom:</label>
									<input type="text" id="mere_prenom" name="mere_prenom" required><br>

									<label for="mere_date_naissance">Date de naissance:</label>
									<input type="date" id="mere_date_naissance" name="mere_date_naissance" required><br>

									<label for="mere_date_deces">Date de décès:</label>
									<input type="date" id="mere_date_deces" name="mere_date_deces" required><br>

									<label for="mere_lieu_naissance">Lieu de naissance:</label>
									<input type="text" id="mere_lieu_naissance" name="mere_lieu_naissance" required><br>
								</div>

								<input type="submit" name="addAncetors" value="Envoyer">
							</form>
					
					{% endif %}
					
				</ul>
			{% endif %}
		{% endmacro %}

		{# Appel initial de la fonction pour la personne recherchée #}
		{{ _self.displayParents(ancestors, originId, originId) }}
	</ul>
{% endblock %}